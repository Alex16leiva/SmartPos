<UserControl x:Class="SmartPos.Views.Seguridad.SeguridadView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:SmartPos.Views.Seguridad"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <Grid Margin="10">
            <mah:MetroTabControl x:Name="MainTabSeguridad" 
                         mah:TabControlHelper.Underlined="SelectedTabItem"
                         mah:HeaderedControlHelper.HeaderFontSize="18">

                <TabItem Header="USUARIOS">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <DockPanel Grid.Row="0" Margin="0,10">
                            <TextBox Width="300" 
                             mah:TextBoxHelper.Watermark="Buscar..." 
                             mah:TextBoxHelper.ButtonContent="🔍"
                             Text="{Binding TextoBusqueda, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource MahApps.Styles.TextBox.Search}"/>
                            <Button Content="NUEVO USUARIO" HorizontalAlignment="Right"
                                Command="{Binding NuevoUsuarioCommand}"    
                                Style="{StaticResource MahApps.Styles.Button.Flat}"
                                Background="#1976D2" Foreground="White" Padding="15,5"/>
                        </DockPanel>

                        <DataGrid Grid.Row="1" AutoGenerateColumns="False" IsReadOnly="True"
                          ItemsSource="{Binding Usuarios}">
                            <DataGrid.Columns>
                                <DataGridTemplateColumn Header="Acciones" Width="80">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button Command="{Binding DataContext.EditarUsuarioCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource MahApps.Styles.Button.Flat}"
                                        Padding="0" Height="25" Width="25"
                                        ToolTip="Editar Artículo">
                                                <TextBlock Text="&#xE70F;" 
                                               FontFamily="Segoe MDL2 Assets" 
                                               FontSize="14" 
                                               Foreground="{DynamicResource MahApps.Brushes.Accent}"
                                               HorizontalAlignment="Center" 
                                               VerticalAlignment="Center"/>
                                            </Button>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Usuario Id" Binding="{Binding UsuarioId}" Width="120"/>
                                <DataGridTextColumn Header="Nombre" Binding="{Binding Nombre}" Width="*"/>
                                <DataGridTextColumn Header="Rol" Binding="{Binding RolId}" Width="150"/>
                                <DataGridTemplateColumn Header="Estado" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Background="#E8F5E9" CornerRadius="10" Padding="5,2">
                                                <TextBlock Text="Activo" Foreground="#4CAF50" HorizontalAlignment="Center" FontWeight="Bold"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                            <TextBlock Text="Registros por página: " VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <ComboBox SelectedValue="{Binding SelectedPageSize}" 
                          ItemsSource="{Binding TamañosPagina}" 
                          SelectedItem="{Binding RegistrosPorPagina}" 
                          Margin="0,0,20,0"/>
                            <Button Command="{Binding AnteriorPaginaCommand}" Content="◀" Style="{StaticResource MahApps.Styles.Button.Flat}"/>
                            <TextBlock VerticalAlignment="Center" Margin="10,0">
                    <Run Text="Página "/>
                    <Run Text="{Binding PaginaActual}" FontWeight="Bold"/>
                    <Run Text=" de "/>
                    <Run Text="{Binding TotalPaginas}" FontWeight="Bold"/>
                            </TextBlock>
                            <Button Command="{Binding SiguientePaginaCommand}" Content="▶" Style="{StaticResource MahApps.Styles.Button.Flat}"/>
                        </StackPanel>
                    </Grid>
                </TabItem>

                <TabItem Header="ROLES">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <DockPanel Grid.Row="0" Margin="0,10">
                            <TextBox Width="300" mah:TextBoxHelper.Watermark="Buscar rol..." 
                         Style="{StaticResource MahApps.Styles.TextBox.Search}"/>
                            <Button Content="+ NUEVO ROL" HorizontalAlignment="Right" 
                        Style="{StaticResource MahApps.Styles.Button.Flat}"
                        Background="#1976D2" Foreground="White"/>
                        </DockPanel>

                        <DataGrid Grid.Row="1" AutoGenerateColumns="False" IsReadOnly="True"
                      ItemsSource="{Binding Roles}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Nombre del Rol" Binding="{Binding Nombre}" Width="200"/>
                                <DataGridTextColumn Header="Descripción" Binding="{Binding Descripcion}" Width="*"/>
                                <DataGridTextColumn Header="Usuarios Vinculados" Binding="{Binding CantidadUsuarios}" Width="150"/>
                                <DataGridTemplateColumn Header="Acciones" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <Button Content="" FontFamily="Segoe MDL2 Assets" ToolTip="Editar" Background="Transparent" BorderThickness="0"/>
                                                <Button Content="" FontFamily="Segoe MDL2 Assets" ToolTip="Eliminar" Background="Transparent" BorderThickness="0" Foreground="Red"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

                <TabItem Header="PERMISOS">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,10">
                            <ComboBox x:Name="CbRoles" Width="300" mah:TextBoxHelper.Watermark="Seleccione un Rol..." />
                            <Button Content="GUARDAR PERMISOS" Margin="10,0" 
                            Background="#1976D2" Foreground="White"
                            Style="{StaticResource MahApps.Styles.Button.Flat}"/>
                        </StackPanel>

                        <DataGrid Grid.Row="1" AutoGenerateColumns="False" ItemsSource="{Binding MatrizPermisos}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Pantalla" Binding="{Binding NombrePantalla}" Width="200" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Descripción" Binding="{Binding Descripcion}" Width="*" IsReadOnly="True"/>
                                <DataGridCheckBoxColumn Header="Ver" Binding="{Binding PuedeVer}" Width="80"/>
                                <DataGridCheckBoxColumn Header="Editar" Binding="{Binding PuedeEditar}" Width="80"/>
                                <DataGridCheckBoxColumn Header="Eliminar" Binding="{Binding PuedeEliminar}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>

            </mah:MetroTabControl>
        </Grid>


        <!--Flyout para gestión de usuarios-->
        <mah:Flyout IsOpen="{Binding IsEditFlyoutUsuarioOpen}" 
                        Header="Gestión de Usuario" 
                        Position="Right" Width="400" 
                        >
            <Grid Margin="15">
                <StackPanel>
                    <TextBlock Text="DATOS DEL USUARIO" FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>

                    <TextBox mah:TextBoxHelper.Watermark="Usuario ID" 
                                 Text="{Binding UsuarioSeleccionado.UsuarioId}" 
                                 IsEnabled="{Binding IsNuevoUsuario}" 
                                 Margin="0,0,0,10"/>

                    <TextBox mah:TextBoxHelper.Watermark="Nombre" 
                                 Text="{Binding UsuarioSeleccionado.Nombre}" 
                                 Margin="0,0,0,10"/>

                    <TextBox mah:TextBoxHelper.Watermark="Apellido" 
                                 Text="{Binding UsuarioSeleccionado.Apellido}" 
                                 Margin="0,0,0,10"/>

                    <PasswordBox mah:TextBoxHelper.Watermark="Nueva Contraseña" 
                                     Margin="0,0,0,5"
                                     x:Name="PasswordCtrl"/>
                    <TextBlock Text="* Dejar vacío para mantener contraseña actual" 
                                   FontSize="10" Foreground="Gray" Margin="0,0,0,15"
                                   Visibility="{Binding EsNuevoUsuario, Converter={StaticResource InverseBoolToVisConverter}}"/>

                    <ComboBox mah:TextBoxHelper.Watermark="Seleccionar Rol"
                                  ItemsSource="{Binding Roles}"
                                  SelectedValue="{Binding UsuarioSeleccionado.RolId}"
                                  SelectedValuePath="RolId"
                                  DisplayMemberPath="Descripcion"
                                  Margin="0,0,0,15"/>

                    <CheckBox Content="Activo" IsChecked="{Binding UsuarioSeleccionado.Activo}" Margin="0,0,0,20"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="CANCELAR" Command="{Binding CancelarCommand}" Margin="0,0,10,0"/>
                        <Button Content="GUARDAR" 
                            Style="{StaticResource MahApps.Styles.Button.Flat}"
                            Command="{Binding GuardarUsuarioCommand}"
                            CommandParameter="{Binding ElementName=PasswordCtrl}"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </mah:Flyout>

    </Grid>
</UserControl>
